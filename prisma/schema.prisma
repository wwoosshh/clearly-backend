generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================
// Enums
// ==================

enum UserRole {
  USER
  COMPANY
  ADMIN
}

enum OAuthProvider {
  LOCAL
  KAKAO
  NAVER
  GOOGLE
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum MatchingStatus {
  REQUESTED
  ACCEPTED
  REJECTED
  CANCELLED
  COMPLETED
}

enum CleaningType {
  MOVE_IN
  MOVE_OUT
  FULL
  OFFICE
  STORE
  AIRCON
  CARPET
  EXTERIOR
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  QUEUED
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum SubscriptionTier {
  BASIC
  PRO
  PREMIUM
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  MATCHING_REQUEST
  MATCHING_ACCEPTED
  MATCHING_REJECTED
  MATCHING_COMPLETED
  MATCHING_CANCELLED
  COMPLETION_REPORTED
  NEW_MESSAGE
  NEW_REVIEW
  SUBSCRIPTION
  SYSTEM
  ESTIMATE_SUBMITTED
  ESTIMATE_ACCEPTED
  ESTIMATE_REJECTED
  NEW_ESTIMATE_REQUEST
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_EXPIRED
}

enum ReportReason {
  FRAUD
  INAPPROPRIATE
  NO_SHOW
  POOR_QUALITY
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum ReportTargetType {
  USER
  COMPANY
  REVIEW
}

enum EstimateRequestStatus {
  OPEN
  CLOSED
  EXPIRED
}

enum EstimateStatus {
  SUBMITTED
  ACCEPTED
  REJECTED
}


enum RefundStatus {
  NONE
  REQUESTED
  APPROVED
  REJECTED
}

enum InquiryStatus {
  PENDING
  ANSWERED
  CLOSED
}

enum DevicePlatform {
  ANDROID
  IOS
  WEB
}

enum PipelineStage {
  LEAD
  CONSULTING
  BOOKED
  COMPLETED
  VIP
}


// ==================
// Models
// ==================

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  passwordHash  String?       @map("password_hash")
  name          String        @db.VarChar(50)
  phone         String?       @db.VarChar(20)
  profileImage  String?       @map("profile_image") @db.VarChar(500)
  role          UserRole      @default(USER)
  oauthProvider OAuthProvider @default(LOCAL) @map("oauth_provider")
  oauthId       String?       @map("oauth_id") @db.VarChar(255)
  isActive             Boolean       @default(true) @map("is_active")
  deactivatedAt        DateTime?     @map("deactivated_at")
  passwordResetToken   String?       @map("password_reset_token")
  passwordResetExpiry  DateTime?     @map("password_reset_expiry")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  company             Company?
  matchings           Matching[]
  chatRoomsAsUser     ChatRoom[]    @relation("UserChatRooms")
  chatMessages        ChatMessage[]
  reviews             Review[]
  notifications       Notification[]
  reportsFiled        Report[]      @relation("ReporterReports")
  refreshTokens       RefreshToken[]
  estimateRequests    EstimateRequest[]
  inquiries           Inquiry[]
  deviceTokens        DeviceToken[]
  customerMemos       CustomerMemo[]

  @@unique([oauthProvider, oauthId])
  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Company {
  id                 String             @id @default(uuid())
  userId             String             @unique @map("user_id")
  businessName       String             @map("business_name") @db.VarChar(100)
  businessNumber     String             @unique @map("business_number") @db.VarChar(20)
  representative     String             @db.VarChar(50)
  address            String?            @db.VarChar(300)
  detailAddress      String?            @map("detail_address") @db.VarChar(200)
  latitude           Decimal?           @db.Decimal(10, 7)
  longitude          Decimal?           @db.Decimal(10, 7)
  serviceAreas       Json?              @map("service_areas")
  description        String?            @db.Text
  profileImages      Json?              @map("profile_images")
  certificates       Json?
  minPrice           Int?               @map("min_price")
  maxPrice           Int?               @map("max_price")
  specialties        Json?
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  rejectionReason    String?            @map("rejection_reason") @db.Text
  averageRating      Decimal            @default(0.0) @map("average_rating") @db.Decimal(2, 1)
  totalReviews       Int                @default(0) @map("total_reviews")
  totalMatchings     Int                @default(0) @map("total_matchings")
  responseTime       Int?               @map("response_time")
  isActive           Boolean            @default(true) @map("is_active")
  contactHours       String?            @map("contact_hours") @db.VarChar(200)
  employeeCount      Int?               @map("employee_count")
  companyUrl         String?            @map("company_url") @db.VarChar(500)
  experienceYears    Int?               @map("experience_years")
  experienceDescription String?         @map("experience_description") @db.Text
  education          String?            @db.VarChar(300)
  serviceDetail      String?            @map("service_detail") @db.Text
  portfolio          Json?
  certificationDocs  Json?              @map("certification_docs")
  businessRegistration String?          @map("business_registration") @db.VarChar(500)
  identityVerified   Boolean            @default(false) @map("identity_verified")
  paymentMethods     Json?              @map("payment_methods")
  contactEmail       String?            @map("contact_email") @db.VarChar(255)
  serviceRange       Int?               @map("service_range")
  videos             Json?
  faq                Json?
  conversionRate      Decimal?          @map("conversion_rate") @db.Decimal(5, 2)
  cancellationRate    Decimal?          @map("cancellation_rate") @db.Decimal(5, 2)
  repeatCustomerRate  Decimal?          @map("repeat_customer_rate") @db.Decimal(5, 2)
  disputeRate         Decimal?          @map("dispute_rate") @db.Decimal(5, 2)
  metricsUpdatedAt    DateTime?         @map("metrics_updated_at")
  searchScore        Decimal?           @map("search_score") @db.Decimal(5, 2)
  searchScoreAt      DateTime?          @map("search_score_at")
  approvedAt         DateTime?          @map("approved_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchings     Matching[]
  chatRooms     ChatRoom[]
  reviews       Review[]
  subscriptions CompanySubscription[]
  estimates     Estimate[]
  customerMemos CustomerMemo[]
  companyTags   CompanyTag[]

  @@index([verificationStatus])
  @@index([averageRating(sort: Desc)])
  @@index([isActive])
  @@map("companies")
}

model Matching {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  companyId      String?        @map("company_id")
  status         MatchingStatus @default(REQUESTED)
  cleaningType   CleaningType   @map("cleaning_type")
  address        String         @db.VarChar(300)
  detailAddress  String?        @map("detail_address") @db.VarChar(200)
  areaSize       Int?           @map("area_size")
  desiredDate    DateTime?      @map("desired_date") @db.Date
  desiredTime    String?        @map("desired_time") @db.VarChar(50)
  message        String?        @db.Text
  estimatedPrice Int?           @map("estimated_price")
  rejectionReason    String?       @map("rejection_reason") @db.Text
  cancelledBy        String?       @map("cancelled_by") @db.VarChar(20)
  completionImages   Json?         @map("completion_images")
  completionReportedAt DateTime?   @map("completion_reported_at")
  estimateId         String?       @unique @map("estimate_id")
  completedAt        DateTime?     @map("completed_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id])
  company  Company?  @relation(fields: [companyId], references: [id])
  estimate Estimate? @relation(fields: [estimateId], references: [id])
  chatRoom ChatRoom?
  review   Review?

  @@index([userId, status])
  @@index([companyId, status])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("matchings")
}

model ChatRoom {
  id              String       @id @default(uuid())
  matchingId      String?      @unique @map("matching_id")
  userId          String       @map("user_id")
  companyId       String       @map("company_id")
  isActive        Boolean      @default(true) @map("is_active")
  lastMessage     String?      @map("last_message") @db.Text
  lastSentAt      DateTime?    @map("last_sent_at")
  userDeclined    Boolean      @default(false) @map("user_declined")
  companyDeclined Boolean      @default(false) @map("company_declined")
  refundStatus    RefundStatus @default(NONE) @map("refund_status")
  estimateId      String?      @unique @map("estimate_id")
  createdAt       DateTime     @default(now()) @map("created_at")

  matching  Matching?     @relation(fields: [matchingId], references: [id])
  user      User          @relation("UserChatRooms", fields: [userId], references: [id])
  company   Company       @relation(fields: [companyId], references: [id])
  estimate  Estimate?     @relation(fields: [estimateId], references: [id])
  messages  ChatMessage[]

  @@index([userId])
  @@index([companyId])
  @@index([isActive])
  @@map("chat_rooms")
}

model ChatMessage {
  id          String      @id @default(uuid())
  roomId      String      @map("room_id")
  senderId    String      @map("sender_id")
  content     String      @db.Text
  messageType MessageType @default(TEXT) @map("message_type")
  fileUrl     String?     @map("file_url") @db.VarChar(500)
  isRead      Boolean     @default(false) @map("is_read")
  createdAt   DateTime    @default(now()) @map("created_at")

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation(fields: [senderId], references: [id])

  @@index([roomId, createdAt(sort: Desc)])
  @@index([senderId])
  @@map("chat_messages")
}

model Review {
  id              String   @id @default(uuid())
  matchingId      String   @unique @map("matching_id")
  userId          String   @map("user_id")
  companyId       String   @map("company_id")
  rating          Int      @db.SmallInt
  qualityRating   Int?     @map("quality_rating") @db.SmallInt
  priceRating     Int?     @map("price_rating") @db.SmallInt
  punctualityRating Int?   @map("punctuality_rating") @db.SmallInt
  kindnessRating  Int?     @map("kindness_rating") @db.SmallInt
  content         String?  @db.Text
  images          Json?
  companyReply    String?  @map("company_reply") @db.Text
  companyRepliedAt DateTime? @map("company_replied_at")
  helpfulCount    Int      @default(0) @map("helpful_count")
  isVisible       Boolean  @default(true) @map("is_visible")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  matching Matching @relation(fields: [matchingId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  company  Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, createdAt(sort: Desc)])
  @@index([companyId, isVisible])
  @@map("reviews")
}

model SubscriptionPlan {
  id                 String           @id @default(uuid())
  name               String           @db.VarChar(50)
  tier               SubscriptionTier
  durationMonths     Int              @map("duration_months")
  price              Int
  dailyEstimateLimit Int              @default(3) @map("daily_estimate_limit")
  features           Json?
  priorityWeight     Decimal          @default(1.0) @map("priority_weight") @db.Decimal(3, 2)
  isActive           Boolean          @default(true) @map("is_active")
  sortOrder          Int              @default(0) @map("sort_order")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  subscriptions CompanySubscription[]

  @@unique([tier, durationMonths])
  @@map("subscription_plans")
}

model CompanySubscription {
  id                 String             @id @default(uuid())
  companyId          String             @map("company_id")
  planId             String             @map("plan_id")
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  isTrial            Boolean            @default(false) @map("is_trial")
  pausedAt           DateTime?          @map("paused_at")
  cancelledAt        DateTime?          @map("cancelled_at")
  paymentMethod      String?            @map("payment_method") @db.VarChar(50)
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  company  Company          @relation(fields: [companyId], references: [id])
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]

  @@index([companyId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("company_subscriptions")
}

model Payment {
  id             String        @id @default(uuid())
  subscriptionId String        @map("subscription_id")
  amount         Int
  status         PaymentStatus @default(PENDING)
  paymentMethod  String?       @map("payment_method") @db.VarChar(50)
  paymentKey     String?       @map("payment_key") @db.VarChar(200)
  receiptUrl     String?       @map("receipt_url") @db.VarChar(500)
  paidAt         DateTime?     @map("paid_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  subscription CompanySubscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@map("payments")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String           @db.VarChar(200)
  content   String?          @db.Text
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([type])
  @@map("notifications")
}

model Report {
  id          String           @id @default(uuid())
  reporterId  String           @map("reporter_id")
  targetType  ReportTargetType @map("target_type")
  targetId    String           @map("target_id")
  reason      ReportReason
  description String?          @db.Text
  status      ReportStatus     @default(PENDING)
  adminNote   String?          @map("admin_note") @db.Text
  createdAt   DateTime         @default(now()) @map("created_at")
  resolvedAt  DateTime?        @map("resolved_at")

  reporter User @relation("ReporterReports", fields: [reporterId], references: [id])

  @@index([status])
  @@index([targetType, targetId])
  @@map("reports")
}

// ==================
// 견적 시스템
// ==================

model EstimateRequest {
  id            String                @id @default(uuid())
  userId        String                @map("user_id")
  cleaningType  CleaningType          @map("cleaning_type")
  address       String                @db.VarChar(300)
  detailAddress String?               @map("detail_address") @db.VarChar(200)
  latitude      Decimal?              @db.Decimal(10, 7)
  longitude     Decimal?              @db.Decimal(10, 7)
  areaSize      Int?                  @map("area_size")
  desiredDate   DateTime?             @map("desired_date") @db.Date
  desiredTime   String?               @map("desired_time") @db.VarChar(50)
  message       String                @db.Text
  budget        Int?
  images        Json?
  checklist     Json?
  maxEstimates  Int                   @default(5) @map("max_estimates")
  status        EstimateRequestStatus @default(OPEN)
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id])
  estimates Estimate[]

  @@index([status, createdAt(sort: Desc)])
  @@index([userId])
  @@index([userId, status])
  @@map("estimate_requests")
}

model Estimate {
  id                String         @id @default(uuid())
  estimateRequestId String         @map("estimate_request_id")
  companyId         String         @map("company_id")
  price             Int
  message           String?        @db.Text
  estimatedDuration String?        @map("estimated_duration") @db.VarChar(50)
  availableDate     DateTime?      @map("available_date") @db.Date
  images            Json?
  status            EstimateStatus @default(SUBMITTED)
  createdAt         DateTime       @default(now()) @map("created_at")

  estimateRequest EstimateRequest @relation(fields: [estimateRequestId], references: [id])
  company         Company         @relation(fields: [companyId], references: [id])
  matching        Matching?
  chatRoom        ChatRoom?

  @@unique([estimateRequestId, companyId])
  @@index([estimateRequestId])
  @@index([companyId])
  @@index([companyId, status])
  @@index([status, createdAt])
  @@map("estimates")
}


// ==================
// FAQ / 문의 시스템
// ==================

model Faq {
  id        String   @id @default(uuid())
  category  String   @db.VarChar(50)
  question  String   @db.VarChar(500)
  answer    String   @db.Text
  sortOrder Int      @default(0) @map("sort_order")
  isVisible Boolean  @default(true) @map("is_visible")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category, sortOrder])
  @@index([isVisible])
  @@map("faqs")
}

model Inquiry {
  id          String        @id @default(uuid())
  userId      String?       @map("user_id")
  name        String        @db.VarChar(50)
  email       String        @db.VarChar(255)
  category    String        @db.VarChar(50)
  title       String        @db.VarChar(200)
  content     String        @db.Text
  status      InquiryStatus @default(PENDING)
  adminAnswer String?       @map("admin_answer") @db.Text
  answeredAt  DateTime?     @map("answered_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt(sort: Desc)])
  @@index([userId])
  @@map("inquiries")
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   // JSON string
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model DeviceToken {
  id        String         @id @default(uuid())
  userId    String         @map("user_id")
  token     String         @unique
  platform  DevicePlatform
  isActive  Boolean        @default(true) @map("is_active")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("device_tokens")
}

model CustomerMemo {
  id            String        @id @default(uuid())
  companyId     String        @map("company_id")
  userId        String        @map("user_id")
  content       String        @db.Text
  pipelineStage PipelineStage @default(LEAD) @map("pipeline_stage")
  tags          String[]      @default([])
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([companyId, pipelineStage])
  @@map("customer_memos")
}

model CompanyTag {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  name      String   @db.VarChar(50)
  color     String   @default("#6b7280") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@map("company_tags")
}
